name: Deploy Laravel to Namecheap cPanel

on:
  push:
    branches:
      - main  # Change this to your deploy branch if needed

jobs:
  deploy:
    name: Deploy to cPanel via SSH
    runs-on: ubuntu-latest

    steps:
      - name: Deploy Laravel Project
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.CPANEL_HOST }}
          username: ${{ secrets.CPANEL_USERNAME }}
          key: ${{ secrets.CPANEL_SSH_KEY }}
          port: 22
          script: |
            echo "ğŸ“¦ Starting deployment on ${{ secrets.CPANEL_HOST }}"

            cd ${{ secrets.CPANEL_DEPLOY_PATH }}

            echo "ğŸ§° Backing up current version..."
            TIMESTAMP=$(date +%Y%m%d%H%M%S)
            BACKUP_DIR=../backup_$TIMESTAMP
            cp -r . $BACKUP_DIR

            set -e
            trap 'echo "âŒ Deployment failed. Rolling back..."; rm -rf ./*; cp -r $BACKUP_DIR/* .; echo "âœ”ï¸ Rollback complete."; exit 1' ERR

            echo "ğŸ“¥ Pulling latest code..."
            git pull origin main

            echo "ğŸ“¦ Installing dependencies..."
            composer install --no-dev --optimize-autoloader

            echo "ğŸ” Setting permissions..."
            find storage -type d -exec chmod 775 {} \;
            find bootstrap/cache -type d -exec chmod 775 {} \;

            echo "âš™ï¸ Running Laravel commands..."
            php artisan migrate --force
            php artisan config:cache
            php artisan route:cache
            php artisan view:cache

            echo "âœ… Deployment successful!"

  notify:
    name: Notify on Failure
    needs: deploy
    if: failure()
    runs-on: ubuntu-latest

    steps:
      - name: Send Failure Email
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.EMAIL_USER }}
          password: ${{ secrets.EMAIL_PASS }}
          subject: "ğŸš¨ Laravel Deployment Failed"
          to: your@email.com
          from: GitHub CI
          body: |
            âŒ Laravel deployment to cPanel failed.

            ğŸ”— Repo: ${{ github.repository }}
            ğŸ§± Branch: ${{ github.ref_name }}
            ğŸ”€ Commit: ${{ github.sha }}

            Please check GitHub Actions logs for more details.
